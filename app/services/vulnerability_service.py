from typing import Any

from app.database import DatabaseManager


class VulnerabilityService:
    def __init__(self, db: DatabaseManager):
        self.vulnerabilities_collection = db.get_vulnerabilities_collection()

    async def read_vulnerability_by_id(self, vulnerability_id: str) -> dict[str, Any]:
        pipeline = [
            { "$match": { "id": vulnerability_id } },
            {
                "$lookup": {
                    "from": "exploits",
                    "localField": "exploits",
                    "foreignField": "id",
                    "as": "exploits"
                }
            },
            {
                "$lookup": {
                    "from": "cwes",
                    "localField": "cwes",
                    "foreignField": "id",
                    "as": "cwes"
                }
            },
            {
                "$set": {
                    "cvss_v3": {
                        "$arrayElemAt": [
                            {
                                "$filter": {
                                    "input": "$severity",
                                    "cond": { "$eq": ["$$this.type", "CVSS_V3"] }
                                }
                            },
                            0
                        ]
                    }
                }
            },
            {
                "$addFields": {
                    "vuln_impact": { "$ifNull": ["$cvss_v3.base_score", 0.0] },
                    "attack_vector": { "$ifNull": ["$cvss_v3.score", ""] }
                }
            }
        ]
        cursor = await self.vulnerabilities_collection.aggregate(pipeline)
        result = await cursor.to_list(length=1)
        return result[0] if result else {
            "vuln_impact": 0.0,
            "attack_vector": "",
        }
